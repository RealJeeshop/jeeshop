package org.rembx.jeeshop.user;

import com.querydsl.core.types.dsl.ComparableExpressionBase;
import com.querydsl.jpa.impl.JPAQuery;
import com.querydsl.jpa.impl.JPAQueryFactory;
import io.quarkus.hibernate.orm.PersistenceUnit;
import org.rembx.jeeshop.user.model.MailTemplate;
import org.rembx.jeeshop.user.model.UserPersistenceUnit;

import javax.annotation.Resource;
import javax.enterprise.context.ApplicationScoped;
import javax.enterprise.context.RequestScoped;
import javax.inject.Inject;
import javax.persistence.EntityManager;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import static org.rembx.jeeshop.user.model.QMailTemplate.mailTemplate;

/**
 * Newsletter finder utility
 */
@ApplicationScoped
public class MailTemplateFinder {

    public final static String DEFAULT_LOCALE = "en_GB";

    private EntityManager entityManager;

    private static final Map<String, ComparableExpressionBase<?>> sortProperties = new HashMap<String, ComparableExpressionBase<?>>() {{
        put("id", mailTemplate.id);
        put("name", mailTemplate.name);
        put("locale", mailTemplate.locale);
        put("creationDate", mailTemplate.creationDate);
        put("updateDate", mailTemplate.updateDate);
    }};

    public static MailTemplateFinder getInstance(EntityManager entityManager) {
        return new MailTemplateFinder(entityManager);
    }

    MailTemplateFinder( @PersistenceUnit(UserPersistenceUnit.NAME) EntityManager entityManager) {
        this.entityManager = entityManager;
    }

    public MailTemplate findByNameAndLocale(String name, String locale) {

        if (locale == null) {
            locale = DEFAULT_LOCALE;
        }

        return new JPAQueryFactory(entityManager)
                .selectFrom(mailTemplate).where(
                        mailTemplate.name.eq(name)
                                .and(mailTemplate.locale.eq(locale).or(mailTemplate.locale.startsWith(locale))))
                .fetchOne();
    }

    public List<MailTemplate> findByName(String name) {

        return new JPAQueryFactory(entityManager)
                .selectFrom(mailTemplate).where(
                        mailTemplate.name.startsWith(name))
                .fetch();
    }

    public List<MailTemplate> findAll(Integer offset, Integer limit, String orderBy, Boolean isDesc) {
        JPAQuery<MailTemplate> query = new JPAQueryFactory(entityManager).selectFrom(mailTemplate);

        if (offset != null)
            query.offset(offset);
        if (limit != null)
            query.limit(limit);

        sortBy(orderBy, isDesc, query);

        return query.fetch();

    }

    public Long countAll() {
        JPAQuery query = new JPAQueryFactory(entityManager).selectFrom(mailTemplate);
        return query.fetchCount();
    }

    private void sortBy(String orderby, Boolean isDesc, JPAQuery<MailTemplate> query) {
        if (orderby != null && sortProperties.containsKey(orderby)) {
            if (isDesc) {
                query.orderBy(sortProperties.get(orderby).desc());
            } else {
                query.orderBy(sortProperties.get(orderby).asc());
            }
        }
    }
}
